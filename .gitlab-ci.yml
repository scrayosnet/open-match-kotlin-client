image: 'registry.scrayos.net/scrayosnet/dev-envs/gradle:8.0.2-jdk17'


cache:
- key: '$CI_PIPELINE_ID'
  paths:
  - 'build'
- key: '$CI_COMMIT_REF_SLUG'
  paths:
  - 'build-cache'
  - '.gradle'


variables:
  ORG_GRADLE_PROJECT_mavenRepositoryTokenType: 'Job-Token'
  ORG_GRADLE_PROJECT_mavenRepositoryToken: '$CI_JOB_TOKEN'


stages:
- 'compile'
- 'test'
- 'coverage'
- 'quality assurance'
- 'deploy'
- 'release'


.job-defaults: &job-defaults
  interruptible: true

.release-job: &release-job
  <<: *job-defaults
  rules:
  - if: '$CI_COMMIT_TAG'
  allow_failure: false

.production-job: &production-job
  <<: *job-defaults
  rules:
  - if: '$CI_COMMIT_BRANCH == "main"'
  - if: '$CI_COMMIT_BRANCH =~ /^hotfix\/.+$/'
  - if: '$CI_COMMIT_TAG'
  # failure can be decided for each job individually

.development-job: &development-job
  <<: *job-defaults
  rules:
  - if: '$CI_COMMIT_BRANCH =~ /^dev\/.+$/'
  allow_failure: true


# compile

compile:
  interruptible: true
  dependencies: []
  needs: []
  stage: 'compile'
  script:
  - './gradlew assemble'


# test

.test: &test
  interruptible: true
  dependencies: []
  needs:
  - 'compile'
  stage: 'test'
  services:
  - 'docker:dind'
  variables:
    DOCKER_HOST: 'tcp://docker:2375'
    DOCKER_TLS_CERTDIR: ''
  script:
  - './gradlew check'
  artifacts:
    paths:
    - 'build/test-results/test/'
    reports:
      junit:
      - 'build/test-results/test/TEST-*.xml'
    when: 'always'

test-production:
  <<: *test
  <<: *production-job

test-development:
  <<: *test
  <<: *development-job


# kover

.kover: &kover
  interruptible: true
  stage: 'coverage'
  script:
  - './gradlew koverReportPrint'
  artifacts:
    paths:
    - 'build/reports/kover'
    when: 'always'
  coverage: '/Total Code Coverage: (\d+(?:\.\d+)?)%/'

kover-production:
  dependencies:
  - 'test-production'
  needs:
  - 'test-production'
  <<: *kover
  <<: *production-job

kover-development:
  dependencies:
  - 'test-development'
  needs:
  - 'test-development'
  <<: *kover
  <<: *development-job


# pitest

.pitest: &pitest
  interruptible: true
  stage: 'coverage'
  services:
  - 'docker:dind'
  variables:
    DOCKER_HOST: 'tcp://docker:2375'
    DOCKER_TLS_CERTDIR: ''
  script:
  - './gradlew pitest'
  cache:
  - key: '$CI_PROJECT_ID'
    paths:
    - 'build/pitHistory.txt'
  artifacts:
    paths:
    - 'build/reports/pitest'
    when: 'always'
  coverage: '/>> Generated \d+ mutations Killed \d+ \((\d+(?:\.\d+)?)%\)/'

pitest-production:
  dependencies:
  - 'test-production'
  needs:
  - 'test-production'
  <<: *pitest
  <<: *production-job

pitest-development:
  dependencies:
  - 'test-development'
  needs:
  - 'test-development'
  <<: *pitest
  <<: *development-job


# sonarqube

.sonarqube: &sonarqube
  interruptible: true
  stage: 'quality assurance'
  script:
  - './gradlew sonar -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN -Dsonar.qualitygate.wait=true'

sonarqube-production:
  dependencies:
  - 'kover-production'
  - 'pitest-production'
  needs:
  - 'kover-production'
  - 'pitest-production'
  <<: *sonarqube
  <<: *production-job

sonarqube-development:
  dependencies:
  - 'kover-development'
  - 'pitest-development'
  needs:
  - 'kover-development'
  - 'pitest-development'
  <<: *sonarqube
  <<: *development-job


# deploy

maven:
  stage: 'deploy'
  dependencies: []
  needs:
  - 'test-production'
  script:
  - './gradlew publish'
  artifacts:
    paths:
    - 'build/libs/*'
  <<: *production-job


# release

release:
  stage: 'release'
  cache: []
  dependencies: []
  needs:
  - 'maven'
  image: 'registry.gitlab.com/gitlab-org/release-cli:latest'
  # necessary until https://gitlab.com/gitlab-org/gitlab/-/issues/223856
  script:
  - 'echo Preparing Release'
  release:
    name: '$CI_COMMIT_TAG'
    tag_name: '$CI_COMMIT_TAG'
    ref: '$CI_COMMIT_TAG'
    description: '${RELEASE_DESCRIPTION//\{\{newline\}\}/\\n}'
  <<: *release-job
